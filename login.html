<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login - Enterprise Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .form-group {
            position: relative;
            margin-bottom: 20px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-input.error {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .form-input.success {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .input-icon:hover {
            color: #374151;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .success-message {
            color: #10b981;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            width: 100%;
            padding: 15px;
            background: white;
            color: #374151;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #d1d5db;
        }
        
        .social-login {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .social-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: white;
            color: #374151;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .social-btn:hover {
            background: #f8f9fa;
            border-color: #d1d5db;
        }
        
        .social-btn i {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .google-btn {
            color: #db4437;
        }
        
        .facebook-btn {
            color: #3b5998;
        }
        
        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e1e5e9;
        }
        
        .divider span {
            background: white;
            padding: 0 15px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        
        .forgot-password {
            text-align: right;
            margin-top: 10px;
        }
        
        .forgot-password a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .forgot-password a:hover {
            text-decoration: underline;
        }
        
        .rate-limit-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .two-factor-container {
            display: none;
            margin-top: 20px;
        }
        
        .verification-code {
            text-align: center;
            font-size: 18px;
            letter-spacing: 5px;
            margin: 10px 0;
        }
        
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        
        .language-selector select {
            padding: 8px;
            border: 1px solid #e1e5e9;
            border-radius: 5px;
            background: white;
        }
        
        .accessibility-skip {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #667eea;
            color: white;
            padding: 8px;
            text-decoration: none;
            transition: top 0.3s;
        }
        
        .accessibility-skip:focus {
            top: 6px;
        }
        
        .security-info {
            margin-top: 20px;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .attempt-counter {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #6b7280;
        }
        
        .ip-info {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
            color: #9ca3af;
        }
        
        @media (max-width: 480px) {
            .login-card {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .social-login {
                flex-direction: column;
            }
            
            .social-btn {
                margin-bottom: 10px;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .login-card {
                border: 2px solid #000;
            }
            
            .form-input {
                border: 2px solid #000;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .login-container {
                background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            }
            
            .login-card {
                background: rgba(30, 30, 46, 0.95);
                color: white;
            }
            
            .form-input {
                background: #2d2d44;
                border-color: #44475a;
                color: white;
            }
            
            .btn-secondary {
                background: #2d2d44;
                border-color: #44475a;
                color: white;
            }
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <select id="languageSelect" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
            <option value="de">Deutsch</option>
            <option value="it">Italiano</option>
            <option value="pt">Português</option>
            <option value="ru">Русский</option>
            <option value="ja">日本語</option>
            <option value="ko">한국어</option>
            <option value="zh">中文</option>
        </select>
    </div>

    <a href="#main-content" class="accessibility-skip">Skip to main content</a>

    <div class="login-container">
        <div class="login-card">
            <div class="rate-limit-warning" id="rateLimitWarning" role="alert" aria-live="polite">
                <i class="fas fa-exclamation-triangle"></i>
                <span data-translate="rateLimitWarning">Too many failed attempts. Please wait before trying again.</span>
            </div>

            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800" data-translate="loginTitle">Secure Login</h1>
                <p class="text-gray-600 mt-2" data-translate="loginSubtitle">Access your account securely</p>
            </div>

            <main id="main-content">
                <form id="loginForm" novalidate>
                    <div class="form-group">
                        <label for="email" class="sr-only" data-translate="emailLabel">Email Address</label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="form-input" 
                            placeholder="Email address"
                            data-translate-placeholder="emailPlaceholder"
                            required 
                            aria-describedby="email-error"
                            autocomplete="email"
                            autofocus
                        >
                        <i class="fas fa-envelope input-icon"></i>
                        <div id="email-error" class="error-message" role="alert" aria-live="polite"></div>
                    </div>

                    <div class="form-group">
                        <label for="password" class="sr-only" data-translate="passwordLabel">Password</label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="form-input" 
                            placeholder="Password"
                            data-translate-placeholder="passwordPlaceholder"
                            required 
                            aria-describedby="password-error"
                            autocomplete="current-password"
                        >
                        <i class="fas fa-eye input-icon" id="togglePassword" onclick="togglePasswordVisibility()"></i>
                        <div id="password-error" class="error-message" role="alert" aria-live="polite"></div>
                    </div>

                    <div class="two-factor-container" id="twoFactorContainer">
                        <div class="form-group">
                            <label for="verificationCode" class="sr-only" data-translate="verificationCodeLabel">Verification Code</label>
                            <input 
                                type="text" 
                                id="verificationCode" 
                                name="verificationCode" 
                                class="form-input verification-code" 
                                placeholder="000000"
                                maxlength="6"
                                pattern="[0-9]{6}"
                                aria-describedby="verification-error"
                                autocomplete="one-time-code"
                            >
                            <div id="verification-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        <p class="text-sm text-gray-600 text-center mb-4" data-translate="verificationCodeInfo">
                            Enter the 6-digit code from your authenticator app
                        </p>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe" class="text-sm text-gray-600" data-translate="rememberMe">Remember me</label>
                    </div>

                    <div class="forgot-password">
                        <a href="#" onclick="showForgotPassword()" data-translate="forgotPassword">Forgot password?</a>
                    </div>

                    <button type="submit" class="btn-primary mt-6" id="loginButton" aria-describedby="login-status">
                        <span id="loginButtonText" data-translate="loginButton">Sign In</span>
                        <div class="loading-spinner" id="loginSpinner">
                            <div class="spinner"></div>
                        </div>
                    </button>

                    <div id="login-status" class="mt-4" role="status" aria-live="polite"></div>
                </form>

                <div class="divider">
                    <span data-translate="orContinue">or continue with</span>
                </div>

                <div class="social-login">
                    <button class="social-btn google-btn" onclick="signInWithGoogle()" aria-label="Sign in with Google">
                        <i class="fab fa-google"></i>
                        <span data-translate="googleLogin">Google</span>
                    </button>
                    <button class="social-btn facebook-btn" onclick="signInWithFacebook()" aria-label="Sign in with Facebook">
                        <i class="fab fa-facebook-f"></i>
                        <span data-translate="facebookLogin">Facebook</span>
                    </button>
                </div>

                <div class="attempt-counter" id="attemptCounter">
                    <span data-translate="attemptCounter">Login attempts: 0/5</span>
                </div>

                <div class="ip-info" id="ipInfo">
                    <span data-translate="ipInfo">Your IP: Loading...</span>
                </div>

                <div class="security-info">
                    <h3 class="font-semibold mb-2" data-translate="securityTitle">Security Information</h3>
                    <ul class="text-sm space-y-1">
                        <li data-translate="securityInfo1">• All login attempts are logged and monitored</li>
                        <li data-translate="securityInfo2">• Your session will expire after 30 minutes of inactivity</li>
                        <li data-translate="securityInfo3">• Two-factor authentication is enabled for enhanced security</li>
                        <li data-translate="securityInfo4">• Report suspicious activity to security@company.com</li>
                    </ul>
                </div>
            </main>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4" data-translate="resetPasswordTitle">Reset Password</h2>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <input 
                        type="email" 
                        id="resetEmail" 
                        class="form-input" 
                        placeholder="Enter your email address"
                        data-translate-placeholder="resetEmailPlaceholder"
                        required
                    >
                    <div id="reset-email-error" class="error-message" role="alert" aria-live="polite"></div>
                </div>
                <div class="flex gap-3 mt-4">
                    <button type="submit" class="btn-primary flex-1" data-translate="sendResetLink">Send Reset Link</button>
                    <button type="button" class="btn-secondary flex-1" onclick="hideForgotPassword()" data-translate="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVYdfql5aqHrChlA1v3nxRLkIbYyWMvUg",
            authDomain: "study2-7bdc7.firebaseapp.com",
            databaseURL: "https://study2-7bdc7-default-rtdb.firebaseio.com",
            projectId: "study2-7bdc7",
            storageBucket: "study2-7bdc7.firebasestorage.app",
            messagingSenderId: "320617984870",
            appId: "1:320617984870:web:04b61ea4ee88ae057e4ea7",
            measurementId: "G-VRM14GRNWG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const analytics = firebase.analytics();

        // Global variables
        let loginAttempts = 0;
        let isRateLimited = false;
        let rateLimitEndTime = 0;
        let currentLanguage = 'en';
        let userIP = '';
        let twoFactorRequired = false;
        let currentUser = null;

        // Internationalization
        const translations = {
            en: {
                loginTitle: "Secure Login",
                loginSubtitle: "Access your account securely",
                emailLabel: "Email Address",
                emailPlaceholder: "Email address",
                passwordLabel: "Password",
                passwordPlaceholder: "Password",
                verificationCodeLabel: "Verification Code",
                verificationCodeInfo: "Enter the 6-digit code from your authenticator app",
                rememberMe: "Remember me",
                forgotPassword: "Forgot password?",
                loginButton: "Sign In",
                orContinue: "or continue with",
                googleLogin: "Google",
                facebookLogin: "Facebook",
                attemptCounter: "Login attempts: ",
                ipInfo: "Your IP: ",
                securityTitle: "Security Information",
                securityInfo1: "• All login attempts are logged and monitored",
                securityInfo2: "• Your session will expire after 30 minutes of inactivity",
                securityInfo3: "• Two-factor authentication is enabled for enhanced security",
                securityInfo4: "• Report suspicious activity to security@company.com",
                resetPasswordTitle: "Reset Password",
                resetEmailPlaceholder: "Enter your email address",
                sendResetLink: "Send Reset Link",
                cancel: "Cancel",
                rateLimitWarning: "Too many failed attempts. Please wait before trying again.",
                invalidEmail: "Please enter a valid email address",
                passwordRequired: "Password is required",
                loginError: "Login failed. Please check your credentials.",
                networkError: "Network error. Please check your connection.",
                twoFactorRequired: "Two-factor authentication required",
                invalidVerificationCode: "Invalid verification code",
                loginSuccess: "Login successful! Redirecting...",
                passwordResetSent: "Password reset email sent successfully"
            },
            es: {
                loginTitle: "Acceso Seguro",
                loginSubtitle: "Accede a tu cuenta de forma segura",
                emailLabel: "Dirección de Correo",
                emailPlaceholder: "Dirección de correo",
                passwordLabel: "Contraseña",
                passwordPlaceholder: "Contraseña",
                verificationCodeLabel: "Código de Verificación",
                verificationCodeInfo: "Ingresa el código de 6 dígitos de tu aplicación de autenticación",
                rememberMe: "Recordarme",
                forgotPassword: "¿Olvidaste tu contraseña?",
                loginButton: "Iniciar Sesión",
                orContinue: "o continuar con",
                googleLogin: "Google",
                facebookLogin: "Facebook",
                attemptCounter: "Intentos de inicio de sesión: ",
                ipInfo: "Tu IP: ",
                securityTitle: "Información de Seguridad",
                securityInfo1: "• Todos los intentos de inicio de sesión son registrados y monitoreados",
                securityInfo2: "• Tu sesión expirará después de 30 minutos de inactividad",
                securityInfo3: "• La autenticación de dos factores está habilitada para mayor seguridad",
                securityInfo4: "• Reporta actividad sospechosa a security@company.com",
                resetPasswordTitle: "Restablecer Contraseña",
                resetEmailPlaceholder: "Ingresa tu dirección de correo",
                sendResetLink: "Enviar Enlace de Restablecimiento",
                cancel: "Cancelar",
                rateLimitWarning: "Demasiados intentos fallidos. Espera antes de intentar de nuevo.",
                invalidEmail: "Por favor ingresa una dirección de correo válida",
                passwordRequired: "La contraseña es requerida",
                loginError: "Error de inicio de sesión. Verifica tus credenciales.",
                networkError: "Error de red. Verifica tu conexión.",
                twoFactorRequired: "Autenticación de dos factores requerida",
                invalidVerificationCode: "Código de verificación inválido",
                loginSuccess: "¡Inicio de sesión exitoso! Redirigiendo...",
                passwordResetSent: "Correo de restablecimiento de contraseña enviado exitosamente"
            },
            fr: {
                loginTitle: "Connexion Sécurisée",
                loginSubtitle: "Accédez à votre compte en toute sécurité",
                emailLabel: "Adresse E-mail",
                emailPlaceholder: "Adresse e-mail",
                passwordLabel: "Mot de passe",
                passwordPlaceholder: "Mot de passe",
                verificationCodeLabel: "Code de Vérification",
                verificationCodeInfo: "Entrez le code à 6 chiffres de votre application d'authentification",
                rememberMe: "Se souvenir de moi",
                forgotPassword: "Mot de passe oublié?",
                loginButton: "Se connecter",
                orContinue: "ou continuer avec",
                googleLogin: "Google",
                facebookLogin: "Facebook",
                attemptCounter: "Tentatives de connexion: ",
                ipInfo: "Votre IP: ",
                securityTitle: "Informations de Sécurité",
                securityInfo1: "• Toutes les tentatives de connexion sont enregistrées et surveillées",
                securityInfo2: "• Votre session expirera après 30 minutes d'inactivité",
                securityInfo3: "• L'authentification à deux facteurs est activée pour une sécurité renforcée",
                securityInfo4: "• Signaler une activité suspecte à security@company.com",
                resetPasswordTitle: "Réinitialiser le Mot de Passe",
                resetEmailPlaceholder: "Entrez votre adresse e-mail",
                sendResetLink: "Envoyer le Lien de Réinitialisation",
                cancel: "Annuler",
                rateLimitWarning: "Trop de tentatives échouées. Veuillez attendre avant de réessayer.",
                invalidEmail: "Veuillez entrer une adresse e-mail valide",
                passwordRequired: "Le mot de passe est requis",
                loginError: "Échec de la connexion. Vérifiez vos identifiants.",
                networkError: "Erreur réseau. Vérifiez votre connexion.",
                twoFactorRequired: "Authentification à deux facteurs requise",
                invalidVerificationCode: "Code de vérification invalide",
                loginSuccess: "Connexion réussie! Redirection...",
                passwordResetSent: "E-mail de réinitialisation du mot de passe envoyé avec succès"
            }
        };

        // Security and logging functions
        class SecurityLogger {
            constructor() {
                this.logs = [];
            }

            logAttempt(type, success, details = {}) {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    timestamp,
                    type,
                    success,
                    ip: userIP,
                    userAgent: navigator.userAgent,
                    details
                };

                this.logs.push(logEntry);
                
                // Store in localStorage for persistence
                const existingLogs = JSON.parse(localStorage.getItem('loginLogs') || '[]');
                existingLogs.push(logEntry);
                localStorage.setItem('loginLogs', JSON.stringify(existingLogs.slice(-100))); // Keep last 100 entries

                // Log to Firebase for server-side monitoring
                if (database) {
                    database.ref('security_logs').push(logEntry);
                }

                console.log(`[SecurityLogger] ${type} - ${success ? 'SUCCESS' : 'FAILED'}`, logEntry);
            }

            getRecentFailures(timeWindow = 15 * 60 * 1000) { // 15 minutes
                const cutoffTime = Date.now() - timeWindow;
                return this.logs.filter(log => 
                    !log.success && 
                    log.type === 'login' && 
                    new Date(log.timestamp).getTime() > cutoffTime
                );
            }
        }

        const securityLogger = new SecurityLogger();

        // Rate limiting implementation
        class RateLimiter {
            constructor(maxAttempts = 5, timeWindow = 15 * 60 * 1000) {
                this.maxAttempts = maxAttempts;
                this.timeWindow = timeWindow;
                this.attempts = this.getStoredAttempts();
            }

            getStoredAttempts() {
                const stored = localStorage.getItem('loginAttempts');
                return stored ? JSON.parse(stored) : [];
            }

            storeAttempts() {
                localStorage.setItem('loginAttempts', JSON.stringify(this.attempts));
            }

            addAttempt() {
                const now = Date.now();
                this.attempts.push(now);
                this.cleanOldAttempts();
                this.storeAttempts();
                loginAttempts = this.attempts.length;
                this.updateAttemptCounter();
            }

            cleanOldAttempts() {
                const cutoffTime = Date.now() - this.timeWindow;
                this.attempts = this.attempts.filter(time => time > cutoffTime);
            }

            isRateLimited() {
                this.cleanOldAttempts();
                return this.attempts.length >= this.maxAttempts;
            }

            getRemainingTime() {
                if (!this.isRateLimited()) return 0;
                const oldestAttempt = Math.min(...this.attempts);
                return Math.max(0, (oldestAttempt + this.timeWindow) - Date.now());
            }

            updateAttemptCounter() {
                const counter = document.getElementById('attemptCounter');
                if (counter) {
                    counter.textContent = `${getTranslation('attemptCounter')}${loginAttempts}/${this.maxAttempts}`;
                }
            }
        }

        const rateLimiter = new RateLimiter();

        // Input validation
        class InputValidator {
            static validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            static validatePassword(password) {
                return password && password.length >= 6;
            }

            static validateVerificationCode(code) {
                return /^\d{6}$/.test(code);
            }

            static sanitizeInput(input) {
                return input.trim().replace(/[<>&"']/g, '');
            }
        }

        // Device verification
        class DeviceVerification {
            constructor() {
                this.deviceId = this.getOrCreateDeviceId();
            }

            getOrCreateDeviceId() {
                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    deviceId = this.generateDeviceId();
                    localStorage.setItem('deviceId', deviceId);
                }
                return deviceId;
            }

            generateDeviceId() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);
                
                const fingerprint = canvas.toDataURL();
                const userAgent = navigator.userAgent;
                const screenRes = `${screen.width}x${screen.height}`;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                return btoa(`${fingerprint}${userAgent}${screenRes}${timezone}`).substr(0, 32);
            }

            isKnownDevice() {
                const knownDevices = JSON.parse(localStorage.getItem('knownDevices') || '[]');
                return knownDevices.includes(this.deviceId);
            }

            markDeviceAsKnown() {
                const knownDevices = JSON.parse(localStorage.getItem('knownDevices') || '[]');
                if (!knownDevices.includes(this.deviceId)) {
                    knownDevices.push(this.deviceId);
                    localStorage.setItem('knownDevices', JSON.stringify(knownDevices));
                }
            }
        }

        const deviceVerification = new DeviceVerification();

        // Session management
        class SessionManager {
            constructor() {
                this.sessionTimeout = 30 * 60 * 1000; // 30 minutes
                this.warningTimeout = 5 * 60 * 1000; // 5 minutes warning
                this.resetTimer();
            }

            resetTimer() {
                clearTimeout(this.warningTimer);
                clearTimeout(this.sessionTimer);

                this.warningTimer = setTimeout(() => {
                    this.showSessionWarning();
                }, this.sessionTimeout - this.warningTimeout);

                this.sessionTimer = setTimeout(() => {
                    this.expireSession();
                }, this.sessionTimeout);
            }

            showSessionWarning() {
                const warning = confirm(getTranslation('sessionWarning') || 'Your session will expire in 5 minutes. Continue?');
                if (warning) {
                    this.resetTimer();
                } else {
                    this.expireSession();
                }
            }

            expireSession() {
                auth.signOut();
                localStorage.removeItem('userSession');
                Cookies.remove('rememberUser');
                window.location.reload();
            }

            extendSession() {
                this.resetTimer();
            }
        }

        let sessionManager;

        // Initialize IP detection
        async function detectUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                userIP = data.ip;
                document.getElementById('ipInfo').textContent = `${getTranslation('ipInfo')}${userIP}`;
            } catch (error) {
                console.error('Failed to detect IP:', error);
                userIP = 'Unknown';
                document.getElementById('ipInfo').textContent = `${getTranslation('ipInfo')}${userIP}`;
            }
        }

        // Translation functions
        function getTranslation(key) {
            return translations[currentLanguage][key] || translations.en[key] || key;
        }

        function updateTranslations() {
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                element.textContent = getTranslation(key);
            });

            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                element.placeholder = getTranslation(key);
            });
        }

        function changeLanguage(language) {
            currentLanguage = language;
            updateTranslations();
            localStorage.setItem('preferredLanguage', language);
        }

        // UI utility functions
        function showElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
            }
        }

        function hideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        function showError(inputId, message) {
            const input = document.getElementById(inputId);
            const errorElement = document.getElementById(`${inputId}-error`);
            
            if (input) {
                input.classList.remove('success');
                input.classList.add('error');
            }
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function showSuccess(inputId, message = '') {
            const input = document.getElementById(inputId);
            const errorElement = document.getElementById(`${inputId}-error`);
            
            if (input) {
                input.classList.remove('error');
                input.classList.add('success');
            }
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = message ? 'block' : 'none';
            }
        }

        function clearValidation(inputId) {
            const input = document.getElementById(inputId);
            const errorElement = document.getElementById(`${inputId}-error`);
            
            if (input) {
                input.classList.remove('error', 'success');
            }
            
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function setLoadingState(isLoading) {
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            if (isLoading) {
                loginButton.disabled = true;
                loginButtonText.style.display = 'none';
                loginSpinner.style.display = 'block';
            } else {
                loginButton.disabled = false;
                loginButtonText.style.display = 'block';
                loginSpinner.style.display = 'none';
            }
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('togglePassword');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Two-factor authentication functions
        function showTwoFactorAuth() {
            document.getElementById('twoFactorContainer').style.display = 'block';
            document.getElementById('verificationCode').focus();
            twoFactorRequired = true;
        }

        function hideTwoFactorAuth() {
            document.getElementById('twoFactorContainer').style.display = 'none';
            twoFactorRequired = false;
        }

        // Forgot password modal functions
        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.remove('hidden');
            document.getElementById('resetEmail').focus();
        }

        function hideForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.add('hidden');
        }

        // Authentication functions
        async function handleEmailPasswordLogin(email, password) {
            try {
                setLoadingState(true);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Check if 2FA is required (simulate for demo)
                if (Math.random() > 0.7) { // 30% chance of 2FA requirement
                    showTwoFactorAuth();
                    securityLogger.logAttempt('2fa_required', true, { userId: user.uid });
                    return;
                }
                
                await handleSuccessfulLogin(user);
                
            } catch (error) {
                await handleLoginError(error);
            } finally {
                setLoadingState(false);
            }
        }

        async function handleTwoFactorVerification(code) {
            try {
                setLoadingState(true);
                
                // Simulate 2FA verification
                if (InputValidator.validateVerificationCode(code)) {
                    const user = auth.currentUser;
                    await handleSuccessfulLogin(user);
                    securityLogger.logAttempt('2fa_verify', true, { userId: user.uid });
                } else {
                    throw new Error('Invalid verification code');
                }
                
            } catch (error) {
                showError('verificationCode', getTranslation('invalidVerificationCode'));
                securityLogger.logAttempt('2fa_verify', false, { code: code.substring(0, 2) + '****' });
            } finally {
                setLoadingState(false);
            }
        }

        async function signInWithGoogle() {
            try {
                setLoadingState(true);
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                const result = await auth.signInWithPopup(provider);
                await handleSuccessfulLogin(result.user);
                
            } catch (error) {
                await handleLoginError(error);
            } finally {
                setLoadingState(false);
            }
        }

        async function signInWithFacebook() {
            try {
                setLoadingState(true);
                
                const provider = new firebase.auth.FacebookAuthProvider();
                provider.addScope('email');
                
                const result = await auth.signInWithPopup(provider);
                await handleSuccessfulLogin(result.user);
                
            } catch (error) {
                await handleLoginError(error);
            } finally {
                setLoadingState(false);
            }
        }

        async function handleSuccessfulLogin(user) {
            currentUser = user;
            
            // Log successful login
            securityLogger.logAttempt('login', true, { 
                userId: user.uid,
                email: user.email,
                method: 'email_password'
            });
            
            // Mark device as known
            deviceVerification.markDeviceAsKnown();
            
            // Store user session
            const userSession = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL,
                timestamp: Date.now()
            };
            
            localStorage.setItem('userSession', JSON.stringify(userSession));
            
            // Handle remember me
            const rememberMe = document.getElementById('rememberMe').checked;
            if (rememberMe) {
                Cookies.set('rememberUser', user.uid, { expires: 30 }); // 30 days
            }
            
            // Initialize session manager
            sessionManager = new SessionManager();
            
            // Clear rate limiting
            localStorage.removeItem('loginAttempts');
            
            // Show success message
            document.getElementById('login-status').innerHTML = `
                <div class="text-green-600 text-center">
                    <i class="fas fa-check-circle"></i> ${getTranslation('loginSuccess')}
                </div>
            `;
            
            // Redirect after delay
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 2000);
        }

        async function handleLoginError(error) {
            console.error('Login error:', error);
            
            // Add failed attempt
            rateLimiter.addAttempt();
            
            // Log failed attempt
            securityLogger.logAttempt('login', false, { 
                error: error.code,
                message: error.message 
            });
            
            // Check rate limiting
            if (rateLimiter.isRateLimited()) {
                showElement('rateLimitWarning');
                isRateLimited = true;
                rateLimitEndTime = Date.now() + rateLimiter.getRemainingTime();
                
                // Disable form
                document.getElementById('loginForm').style.opacity = '0.5';
                document.getElementById('loginForm').style.pointerEvents = 'none';
                
                // Start countdown
                startRateLimitCountdown();
            }
            
            // Show appropriate error message
            let errorMessage = getTranslation('loginError');
            
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    errorMessage = getTranslation('loginError');
                    break;
                case 'auth/invalid-email':
                    errorMessage = getTranslation('invalidEmail');
                    showError('email', errorMessage);
                    return;
                case 'auth/network-request-failed':
                    errorMessage = getTranslation('networkError');
                    break;
                case 'auth/too-many-requests':
                    errorMessage = getTranslation('rateLimitWarning');
                    break;
                default:
                    errorMessage = error.message;
            }
            
            document.getElementById('login-status').innerHTML = `
                <div class="text-red-600 text-center">
                    <i class="fas fa-exclamation-circle"></i> ${errorMessage}
                </div>
            `;
        }

        function startRateLimitCountdown() {
            const updateCountdown = () => {
                const remaining = rateLimitEndTime - Date.now();
                if (remaining <= 0) {
                    isRateLimited = false;
                    hideElement('rateLimitWarning');
                    document.getElementById('loginForm').style.opacity = '1';
                    document.getElementById('loginForm').style.pointerEvents = 'auto';
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                document.getElementById('rateLimitWarning').innerHTML = `
                    <i class="fas fa-clock"></i>
                    ${getTranslation('rateLimitWarning')} (${minutes}:${seconds.toString().padStart(2, '0')})
                `;
                
                setTimeout(updateCountdown, 1000);
            };
            
            updateCountdown();
        }

        // Password reset functionality
        async function handlePasswordReset(email) {
            try {
                await auth.sendPasswordResetEmail(email);
                
                securityLogger.logAttempt('password_reset', true, { email });
                
                document.getElementById('login-status').innerHTML = `
                    <div class="text-green-600 text-center">
                        <i class="fas fa-check-circle"></i> ${getTranslation('passwordResetSent')}
                    </div>
                `;
                
                hideForgotPassword();
                
            } catch (error) {
                securityLogger.logAttempt('password_reset', false, { email, error: error.code });
                
                let errorMessage = error.message;
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email address';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = getTranslation('invalidEmail');
                }
                
                showError('resetEmail', errorMessage);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize
            detectUserIP();
            
            // Load preferred language
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
                document.getElementById('languageSelect').value = savedLanguage;
                updateTranslations();
            }
            
            // Check for remembered user
            const rememberedUser = Cookies.get('rememberUser');
            if (rememberedUser) {
                // Auto-fill or show logged in state
                console.log('Remembered user:', rememberedUser);
            }
            
            // Update attempt counter
            rateLimiter.updateAttemptCounter();
            
            // Form submission
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (isRateLimited) {
                    return;
                }
                
                const email = InputValidator.sanitizeInput(document.getElementById('email').value);
                const password = document.getElementById('password').value;
                
                // Clear previous validation
                clearValidation('email');
                clearValidation('password');
                clearValidation('verificationCode');
                
                // Validate inputs
                let isValid = true;
                
                if (!InputValidator.validateEmail(email)) {
                    showError('email', getTranslation('invalidEmail'));
                    isValid = false;
                }
                
                if (!InputValidator.validatePassword(password)) {
                    showError('password', getTranslation('passwordRequired'));
                    isValid = false;
                }
                
                if (!isValid) {
                    return;
                }
                
                // Handle two-factor authentication
                if (twoFactorRequired) {
                    const verificationCode = document.getElementById('verificationCode').value;
                    if (!InputValidator.validateVerificationCode(verificationCode)) {
                        showError('verificationCode', getTranslation('invalidVerificationCode'));
                        return;
                    }
                    
                    await handleTwoFactorVerification(verificationCode);
                } else {
                    await handleEmailPasswordLogin(email, password);
                }
            });
            
            // Forgot password form
            document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = InputValidator.sanitizeInput(document.getElementById('resetEmail').value);
                
                if (!InputValidator.validateEmail(email)) {
                    showError('resetEmail', getTranslation('invalidEmail'));
                    return;
                }
                
                await handlePasswordReset(email);
            });
            
            // Real-time validation
            document.getElementById('email').addEventListener('input', function() {
                const email = this.value;
                if (email && InputValidator.validateEmail(email)) {
                    showSuccess('email');
                } else if (email) {
                    showError('email', getTranslation('invalidEmail'));
                } else {
                    clearValidation('email');
                }
            });
            
            document.getElementById('password').addEventListener('input', function() {
                const password = this.value;
                if (password && InputValidator.validatePassword(password)) {
                    showSuccess('password');
                } else if (password) {
                    showError('password', getTranslation('passwordRequired'));
                } else {
                    clearValidation('password');
                }
            });
            
            document.getElementById('verificationCode').addEventListener('input', function() {
                const code = this.value;
                if (code && InputValidator.validateVerificationCode(code)) {
                    showSuccess('verificationCode');
                } else if (code) {
                    showError('verificationCode', getTranslation('invalidVerificationCode'));
                } else {
                    clearValidation('verificationCode');
                }
            });
            
            // Activity tracking for session management
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, function() {
                    if (sessionManager) {
                        sessionManager.extendSession();
                    }
                }, { passive: true });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    document.getElementById('loginForm').dispatchEvent(new Event('submit'));
                }
                
                if (e.key === 'Escape') {
                    hideForgotPassword();
                }
            });
            
            // Close modal on outside click
            document.getElementById('forgotPasswordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideForgotPassword();
                }
            });
        });

        // Unit Tests
        class LoginPageTests {
            constructor() {
                this.testResults = [];
            }
            
            async runAllTests() {
                console.log('Running login page tests...');
                
                this.testInputValidation();
                this.testRateLimiting();
                this.testDeviceVerification();
                this.testTranslations();
                this.testSecurityLogger();
                this.testSessionManager();
                
                console.log('Test Results:', this.testResults);
                
                const passed = this.testResults.filter(test => test.passed).length;
                const total = this.testResults.length;
                
                console.log(`Tests completed: ${passed}/${total} passed`);
                
                return { passed, total, results: this.testResults };
            }
            
            testInputValidation() {
                console.log('Testing input validation...');
                
                // Test email validation
                this.assert(
                    InputValidator.validateEmail('test@example.com'),
                    'Valid email should pass validation'
                );
                
                this.assert(
                    !InputValidator.validateEmail('invalid-email'),
                    'Invalid email should fail validation'
                );
                
                // Test password validation
                this.assert(
                    InputValidator.validatePassword('password123'),
                    'Valid password should pass validation'
                );
                
                this.assert(
                    !InputValidator.validatePassword('123'),
                    'Short password should fail validation'
                );
                
                // Test verification code validation
                this.assert(
                    InputValidator.validateVerificationCode('123456'),
                    'Valid verification code should pass validation'
                );
                
                this.assert(
                    !InputValidator.validateVerificationCode('12345'),
                    'Invalid verification code should fail validation'
                );
                
                // Test input sanitization
                this.assert(
                    InputValidator.sanitizeInput('  test@example.com  ') === 'test@example.com',
                    'Input should be trimmed'
                );
            }
            
            testRateLimiting() {
                console.log('Testing rate limiting...');
                
                const testRateLimiter = new RateLimiter(3, 60000); // 3 attempts in 1 minute
                
                // Test initial state
                this.assert(
                    !testRateLimiter.isRateLimited(),
                    'Should not be rate limited initially'
                );
                
                // Add attempts
                testRateLimiter.addAttempt();
                testRateLimiter.addAttempt();
                testRateLimiter.addAttempt();
                
                this.assert(
                    testRateLimiter.isRateLimited(),
                    'Should be rate limited after max attempts'
                );
            }
            
            testDeviceVerification() {
                console.log('Testing device verification...');
                
                const testDevice = new DeviceVerification();
                
                this.assert(
                    testDevice.deviceId && testDevice.deviceId.length > 0,
                    'Device ID should be generated'
                );
                
                this.assert(
                    testDevice.deviceId === testDevice.getOrCreateDeviceId(),
                    'Device ID should be consistent'
                );
            }
            
            testTranslations() {
                console.log('Testing translations...');
                
                this.assert(
                    getTranslation('loginTitle') === 'Secure Login',
                    'English translation should work'
                );
                
                currentLanguage = 'es';
                this.assert(
                    getTranslation('loginTitle') === 'Acceso Seguro',
                    'Spanish translation should work'
                );
                
                currentLanguage = 'en'; // Reset
            }
            
            testSecurityLogger() {
                console.log('Testing security logger...');
                
                const testLogger = new SecurityLogger();
                
                testLogger.logAttempt('test', true, { testData: 'test' });
                
                this.assert(
                    testLogger.logs.length === 1,
                    'Logger should record attempts'
                );
                
                this.assert(
                    testLogger.logs[0].type === 'test',
                    'Logger should record correct type'
                );
            }
            
            testSessionManager() {
                console.log('Testing session manager...');
                
                const testSession = new SessionManager();
                
                this.assert(
                    testSession.sessionTimeout === 30 * 60 * 1000,
                    'Session timeout should be 30 minutes'
                );
                
                this.assert(
                    testSession.warningTimeout === 5 * 60 * 1000,
                    'Warning timeout should be 5 minutes'
                );
            }
            
            assert(condition, message) {
                const result = {
                    passed: condition,
                    message: message,
                    timestamp: new Date().toISOString()
                };
                
                this.testResults.push(result);
                
                if (condition) {
                    console.log(`✓ ${message}`);
                } else {
                    console.error(`✗ ${message}`);
                }
            }
        }

        // Run tests in development mode
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const tests = new LoginPageTests();
            setTimeout(() => {
                tests.runAllTests();
            }, 1000);
        }

        // Accessibility improvements
        function initializeAccessibility() {
            // Add ARIA live regions for dynamic content
            const liveRegion = document.createElement('div');
            liveRegion.setAttribute('aria-live', 'polite');
            liveRegion.setAttribute('aria-atomic', 'true');
            liveRegion.className = 'sr-only';
            liveRegion.id = 'announcements';
            document.body.appendChild(liveRegion);
            
            // Announce form validation errors
            const originalShowError = showError;
            showError = function(inputId, message) {
                originalShowError(inputId, message);
                document.getElementById('announcements').textContent = message;
            };
            
            // Add keyboard navigation for custom elements
            document.querySelectorAll('.social-btn').forEach(btn => {
                btn.setAttribute('tabindex', '0');
                btn.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        }

        // Initialize accessibility features
        document.addEventListener('DOMContentLoaded', initializeAccessibility);

        // Performance monitoring
        function initializePerformanceMonitoring() {
            if ('performance' in window) {
                window.addEventListener('load', function() {
                    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                    console.log(`Page load time: ${loadTime}ms`);
                    
                    // Log performance metrics
                    securityLogger.logAttempt('performance', true, {
                        loadTime,
                        domContentLoaded: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart,
                        firstPaint: performance.getEntriesByType('paint')[0]?.startTime || 0
                    });
                });
            }
        }

        initializePerformanceMonitoring();

        // Export functions for testing
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = {
                InputValidator,
                RateLimiter,
                DeviceVerification,
                SecurityLogger,
                SessionManager,
                LoginPageTests
            };
        }
    </script>
</body>
</html>