<!-- Here's the complete code for the interview taking page:

```html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Interview</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://images.unsplash.com/photo-1576091160550-2173dba999ef?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed; background-size: cover; color: #fff;">

<div id="auth-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: #fff; padding: 20px; border-radius: 8px; text-align: center;">
        <h2 style="color: #333;">Authentication Required</h2>
        <p style="color: #555;">You need to be logged in to access this page.</p>
        <button onclick="redirectToLogin()" style="background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">Go to Login</button>
    </div>
</div>

<div id="interview-page" style="display: none; max-width: 1200px; margin: 0 auto; padding: 20px;">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px;">
        <div style="display: flex; align-items: center;">
            <img id="interviewer-avatar" src="https://ui-avatars.com/api/?name=AI+Interviewer&background=4285f4&color=fff" alt="Interviewer Avatar" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 15px;">
            <div>
                <h1 style="margin: 0; font-size: 1.5em;">Interview with <span id="interviewer-name">AI Interviewer</span></h1>
                <p style="margin: 5px 0 0; color: #ccc; font-size: 0.9em;">You're doing great! Keep going!</p>
            </div>
        </div>
        <div style="text-align: right;">
            <div id="timer-display" style="font-size: 1.2em; font-weight: bold; color: #ff9800; background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 20px;"></div>
            <p style="margin: 5px 0 0; color: #aaa; font-size: 0.8em;">Time Remaining</p>
        </div>
    </header>

    <div id="progress-container" style="width: 100%; background-color: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 30px;">
        <div id="progress-bar" style="height: 10px; background-color: #4CAF50; width: 0%; border-radius: 10px; transition: width 0.3s;"></div>
    </div>

    <div id="interview-container" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 10px; padding: 25px; min-height: 400px; position: relative;">
        <div id="question-container" style="margin-bottom: 25px;">
            <h2 id="question-number" style="margin: 0 0 5px; font-size: 1.2em; color: #4CAF50;">Question 1 of 10</h2>
            <p id="question-text" style="font-size: 1.5em; margin: 0 0 20px; line-height: 1.4; min-height: 80px;">Loading question...</p>
            <div id="question-hints" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                <h3 style="margin: 0 0 10px; font-size: 1.1em; color: #ff9800;">Tips & Hints</h3>
                <p id="hint-text" style="margin: 0; line-height: 1.5;"></p>
            </div>
        </div>

        <div id="answer-container" style="margin-bottom: 20px;">
            <label for="user-answer" style="display: block; margin-bottom: 10px; font-weight: bold; color: #ddd;">Your Answer:</label>
            <textarea id="user-answer" rows="8" style="width: 100%; padding: 15px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: #fff; border-radius: 8px; font-size: 1.1em; margin-bottom: 10px; resize: vertical;"></textarea>
            
            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between; align-items: center;">
                <div>
                    <button id="record-audio-btn" style="background: #9c27b0; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y1="23"></line>
                        </svg>
                        Record Audio
                    </button>
                    <div id="audio-indicator" style="display: none; font-size: 0.9em; color: #ff9800; margin-top: 5px;">
                        <span id="recording-time">00:00</span> Recording...
                    </div>
                </div>
                
                <div>
                    <button id="toggle-hints-btn" style="background: #2196F3; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-right: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        Toggle Hints
                    </button>
                    <button id="flag-question-btn" style="background: #ff5722; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-right: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                            <line x1="4" y1="22" x2="4" y2="15"></line>
                        </svg>
                        Flag for Review
                    </button>
                </div>
            </div>
        </div>

        <div id="action-buttons" style="display: flex; justify-content: space-between; margin-top: 30px;">
            <div>
                <button id="prev-question-btn" style="background: #607d8b; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Previous Question
                </button>
            </div>
            <div>
                <button id="pause-timer-btn" style="background: #795548; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                    Pause
                </button>
                <button id="skip-question-btn" style="background: #9e9e9e; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                        <polygon points="5 4 15 12 5 20 5 4"></polygon>
                        <line x1="19" y1="5" x2="19" y2="19"></line>
                    </svg>
                    Skip Question
                </button>
                <button id="submit-answer-btn" style="background: #4CAF50; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                        <path d="M22 2L11 13"></path>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    Submit Answer
                </button>
            </div>
        </div>
    </div>

    <div id="help-section" style="margin-top: 30px;">
        <button id="help-btn" style="background: transparent; color: #2196F3; border: 1px solid #2196F3; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Need Help?
        </button>
        <div id="help-content" style="display: none; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-top: 10px;">
            <h3 style="margin: 0 0 10px; font-size: 1.1em;">Interview Assistance</h3>
            <p style="margin: 0 0 10px;">If you're experiencing any issues during the interview, here are some options:</p>
            <ul style="margin: 0 0 10px; padding-left: 20px;">
                <li>Check your internet connection if you're experiencing delays</li>
                <li>Use the "Toggle Hints" button for help with the current question</li>
                <li>Flag questions you want to review later with the "Flag" button</li>
                <li>Pause the interview if you need a break</li>
            </ul>
            <p style="margin: 0;">For immediate assistance, please contact support.</p>
        </div>
    </div>

    <div id="network-status" style="position: fixed; bottom: 20px; right: 20px; padding: 10px 15px; background: rgba(0,0,0,0.7); border-radius: 20px; display: none;">
        <span id="network-icon" style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #f44336; margin-right: 8px;"></span>
        <span id="network-message">Network connection lost</span>
    </div>

    <div id="audio-visualizer" style="position: absolute; bottom: 10px; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.1); display: none;">
        <div id="visualizer-bar" style="position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg, #ff5722, #ff9800); transition: width 0.1s linear;"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-functions.js"></script>

<script>
    // Firebase configuration
   const firebaseConfig = {
  apiKey: "AIzaSyABwi4-Rzl7T1qGLyWAWIAFcUxEivSX_BE",
  authDomain: "whizan-coding--agent.firebaseapp.com",
  projectId: "whizan-coding--agent",
  storageBucket: "whizan-coding--agent.firebasestorage.app",
  messagingSenderId: "798036544047",
  appId: "1:798036544047:web:ff7f8d3c44f40087e8d4da",
  measurementId: "G-8DJEL3Q4RH"
};


    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    // Global variables
    let interviewId;
    let interviewData;
    let questions = [];
    let currentQuestionIndex = 0;
    let timerInterval;
    let timeRemaining;
    let isTimerPaused = false;
    let audioStream;
    let audioRecorder;
    let audioChunks = [];
    let recordingStartTime;
    let recordingInterval;
    let wsConnection;
    let networkStatusCheckInterval;
    let isNetworkConnected = true;

    // DOM elements
    const authContainer = document.getElementById('auth-container');
    const interviewPage = document.getElementById('interview-page');
    const questionText = document.getElementById('question-text');
    const questionNumber = document.getElementById('question-number');
    const userAnswer = document.getElementById('user-answer');
    const progressBar = document.getElementById('progress-bar');
    const timerDisplay = document.getElementById('timer-display');
    const prevQuestionBtn = document.getElementById('prev-question-btn');
    const skipQuestionBtn = document.getElementById('skip-question-btn');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');
    const pauseTimerBtn = document.getElementById('pause-timer-btn');
    const toggleHintsBtn = document.getElementById('toggle-hints-btn');
    const flagQuestionBtn = document.getElementById('flag-question-btn');
    const questionHints = document.getElementById('question-hints');
    const hintText = document.getElementById('hint-text');
    const helpBtn = document.getElementById('help-btn');
    const helpContent = document.getElementById('help-content');
    const recordAudioBtn = document.getElementById('record-audio-btn');
    const audioIndicator = document.getElementById('audio-indicator');
    const recordingTime = document.getElementById('recording-time');
    const audioVisualizer = document.getElementById('audio-visualizer');
    const visualizerBar = document.getElementById('visualizer-bar');
    const networkStatus = document.getElementById('network-status');
    const networkIcon = document.getElementById('network-icon');
    const networkMessage = document.getElementById('network-message');

    // Check authentication state on page load
    auth.onAuthStateChanged(user => {
        if (user) {
            // User is signed in
            authContainer.style.display = 'none';
            interviewPage.style.display = 'block';
            
            // Get interview ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            interviewId = urlParams.get('id');
            
            if (interviewId) {
                initializeInterview();
            } else {
                showError('Invalid interview ID');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 3000);
            }
        } else {
            // No user is signed in
            authContainer.style.display = 'flex';
        }
    });

    // Initialize interview data and UI
    async function initializeInterview() {
        try {
            // Fetch interview data
            const interviewDoc = await db.collection('interviews').doc(interviewId).get();
            if (!interviewDoc.exists) {
                throw new Error('Interview not found');
            }
            
            interviewData = interviewDoc.data();
            
            // Check if interview is already completed
            if (interviewData.status === 'completed') {
                window.location.href = `interview_results.html?id=${interviewId}`;
                return;
            }
            
            // Initialize timer
            timeRemaining = interviewData.timeLimit * 60; // Convert minutes to seconds
            updateTimerDisplay();
            startTimer();
            
            // Set up interviewer info
            const interviewerName = document.getElementById('interviewer-name');
            if (interviewData.interviewerName) {
                interviewerName.textContent = interviewData.interviewerName;
            }
            
            const interviewerAvatar = document.getElementById('interviewer-avatar');
            if (interviewData.interviewerAvatar) {
                interviewerAvatar.src = interviewData.interviewerAvatar;
            }
            
            // Fetch questions
            const questionsQuery = await db.collection('questions')
                .where('interviewId', '==', interviewId)
                .orderBy('order')
                .get();
                
            questions = questionsQuery.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            if (questions.length === 0) {
                throw new Error('No questions found for this interview');
            }
            
            // Initialize WebSocket connection for real-time feedback
            initializeWebSocket();
            
            // Set up network monitoring
            setupNetworkMonitor();
            
            // Display first question
            displayQuestion(currentQuestionIndex);
            updateProgressBar();
            
            // Set up event listeners
            setupEventListeners();
        } catch (error) {
            showError(error.message);
            console.error('Interview initialization error:', error);
        }
    }

    // Set up event listeners
    function setupEventListeners() {
        prevQuestionBtn.addEventListener('click', showPreviousQuestion);
        skipQuestionBtn.addEventListener('click', skipQuestion);
        submitAnswerBtn.addEventListener('click', submitAnswer);
        pauseTimerBtn.addEventListener('click', toggleTimerPause);
        toggleHintsBtn.addEventListener('click', toggleHints);
        flagQuestionBtn.addEventListener('click', flagQuestion);
        helpBtn.addEventListener('click', toggleHelp);
        recordAudioBtn.addEventListener('click', toggleAudioRecording);
        
        // Handle window resize for responsive design
        window.addEventListener('resize', handleResize);
        
        // Handle beforeunload to warn about leaving the interview
        window.addEventListener('beforeunload', (e) => {
            if (currentQuestionIndex < questions.length - 1) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your progress may be lost.';
            }
        });
    }

    // Display question at given index
    function displayQuestion(index) {
        if (index < 0 || index >= questions.length) return;
        
        const question = questions[index];
        questionText.textContent = question.text;
        questionNumber.textContent = `Question ${index + 1} of ${questions.length}`;
        userAnswer.value = question.userAnswer || '';
        hintText.textContent = question.hint || 'Think about the key concepts related to this question and structure your answer clearly.';
        
        // Show/hide previous button based on question index
        prevQuestionBtn.style.display = index > 0 ? 'block' : 'none';
        
        // Update skip button text for last question
        if (index === questions.length - 1) {
            skipQuestionBtn.textContent = 'Finish Interview';
        } else {
            skipQuestionBtn.textContent = 'Skip Question';
        }
        
        // Reset audio recording state
        if (audioRecorder && audioRecorder.state !== 'inactive') {
            stopAudioRecording();
        }
    }

    // Show previous question
    function showPreviousQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            displayQuestion(currentQuestionIndex);
        }
    }

    // Skip current question
    function skipQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            displayQuestion(currentQuestionIndex);
            updateProgressBar();
        } else {
            completeInterview();
        }
    }

    // Submit answer for current question
    async function submitAnswer() {
        const answer = userAnswer.value.trim();
        if (!answer) {
            showError('Please provide an answer before submitting.');
            return;
        }
        
        try {
            const questionId = questions[currentQuestionIndex].id;
            
            // Update the question document with user's answer
            await db.collection('questions').doc(questionId).update({
                userAnswer: answer,
                answeredAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Trigger Cloud Function to generate feedback
            const generateFeedback = functions.httpsCallable('generateFeedback');
            await generateFeedback({ questionId: questionId });
            
            // Move to next question or complete interview
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
                updateProgressBar();
            } else {
                completeInterview();
            }
        } catch (error) {
            showError('Failed to submit answer. Please try again.');
            console.error('Answer submission error:', error);
        }
    }

    // Complete the interview
    async function completeInterview() {
        try {
            // Calculate overall score based on individual question scores
            let totalScore = 0;
            let answeredQuestions = 0;
            
            const scores = await Promise.all(questions.map(async q => {
                const doc = await db.collection('questions').doc(q.id).get();
                return doc.data().score || 0;
            }));
            
            totalScore = scores.reduce((sum, score) => sum + score, 0);
            answeredQuestions = scores.filter(score => score > 0).length;
            
            const overallScore = answeredQuestions > 0 ? totalScore / answeredQuestions : 0;
            
            // Update interview document with completion status and overall score
            await db.collection('interviews').doc(interviewId).update({
                status: 'completed',
                completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                score: overallScore,
                overallFeedback: generateOverallFeedback(overallScore)
            });
            
            // Redirect to results page
            window.location.href = `interview_results.html?id=${interviewId}`;
        } catch (error) {
            showError('Failed to complete interview. Please try again.');
            console.error('Interview completion error:', error);
        }
    }

    // Generate overall feedback based on score
    function generateOverallFeedback(score) {
        if (score >= 90) {
            return "Exceptional performance! Your responses demonstrated deep understanding and clear articulation of key concepts.";
        } else if (score >= 75) {
            return "Strong performance. You provided comprehensive answers with good structure and relevant examples.";
        } else if (score >= 60) {
            return "Good effort. Your answers were generally correct but could benefit from more depth or clarity.";
        } else if (score >= 40) {
            return "Fair performance. Some answers were incomplete or lacked critical details.";
        } else {
            return "Needs improvement. Review the material and practice structuring your responses more effectively.";
        }
    }

    // Start or resume the timer
    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (!isTimerPaused) {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timeExpired();
                }
            }
        }, 1000);
    }

    // Update timer display
    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is running low
        if (timeRemaining <= 60) {
            timerDisplay.style.color = '#f44336';
        } else if (timeRemaining <= 300) {
            timerDisplay.style.color = '#ff9800';
        } else {
            timerDisplay.style.color = '#4CAF50';
        }
    }

    // Handle time expiration
    function timeExpired() {
        showError('Time has expired! Your answers will be automatically submitted.');
        setTimeout(() => {
            completeInterview();
        }, 3000);
    }

    // Toggle timer pause/resume
    function toggleTimerPause() {
        isTimerPaused = !isTimerPaused;
        
        if (isTimerPaused) {
            pauseTimerBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Resume
            `;
            pauseTimerBtn.style.backgroundColor = '#4CAF50';
        } else {
            pauseTimerBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
                Pause
            `;
            pauseTimerBtn.style.backgroundColor = '#795548';
        }
        
        startTimer();
    }

    // Update progress bar
    function updateProgressBar() {
        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        progressBar.style.width = `${progress}%`;
    }

    // Toggle hints visibility
    function toggleHints() {
        if (questionHints.style.display === 'none') {
            questionHints.style.display = 'block';
            toggleHintsBtn.innerHTML = `
                < xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Hide Hints
            `;
        } else {
            questionHints.style.display = 'none';
            toggleHintsBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Show Hints
            `;
        }
    }

    // Flag question for review
    async function flagQuestion() {
        const questionId = questions[currentQuestionIndex].id;
        try {
            await db.collection('questions').doc(questionId).update({
                flagged: true
            });
            showSuccess('Question flagged for review.');
        } catch (error) {
            showError('Failed to flag question. Please try again.');
            console.error('Flag question error:', error);
        }
    }

    // Toggle help section visibility
    function toggleHelp() {
        if (helpContent.style.display === 'none') {
            helpContent.style.display = 'block';
        } else {
            helpContent.style.display = 'none';
        }
    }

    // Toggle audio recording
    async function toggleAudioRecording() {
        if (audioRecorder && audioRecorder.state !== 'inactive') {
            stopAudioRecording();
        } else {
            startAudioRecording();
        }
    }

    // Start audio recording
    async function startAudioRecording() {
        try {
            audioChunks = [];
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioRecorder = new MediaRecorder(audioStream);
            
            audioRecorder.ondataavailable = (e) => {
                audioChunks.push(e.data);
            };
            
            audioRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                await uploadAudio(audioBlob);
            };
            
            audioRecorder.start(100); // Get data every 100ms
            recordingStartTime = Date.now();
            updateRecordingTime();
            recordingInterval = setInterval(updateRecordingTime, 1000);
            
            // Visualize audio
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(audioStream);
            microphone.connect(analyser);
            analyser.fftSize = 256;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            function updateVisualizer() {
                if (audioRecorder && audioRecorder.state !== 'inactive') {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;
                    visualizerBar.style.width = `${average}%`;
                    requestAnimationFrame(updateVisualizer);
                }
            }
            updateVisualizer();
            
            // Update UI
            recordAudioBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
                Stop Recording
            `;
            recordAudioBtn.style.backgroundColor = '#f44336';
            audioIndicator.style.display = 'block';
            audioVisualizer.style.display = 'block';
        } catch (error) {
            showError('Failed to start recording. Please check microphone permissions.');
            console.error('Audio recording error:', error);
        }
    }

    // Stop audio recording
    function stopAudioRecording() {
        if (audioRecorder && audioRecorder.state !== 'inactive') {
            audioRecorder.stop();
            audioStream.getTracks().forEach(track => track.stop());
            clearInterval(recordingInterval);
            
            // Update UI
            recordAudioBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                Record Audio
            `;
            recordAudioBtn.style.backgroundColor = '#9c27b0';
            audioIndicator.style.display = 'none';
            audioVisualizer.style.display = 'none';
            visualizerBar.style.width = '0%';
        }
    }

    // Update recording time display
    function updateRecordingTime() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        recordingTime.textContent = `${minutes}:${seconds}`;
    }

    // Upload audio to storage and update question
    async function uploadAudio(audioBlob) {
        try {
            const questionId = questions[currentQuestionIndex].id;
            const storageRef = firebase.storage().ref(`audio_answers/${questionId}.wav`);
            
            // Upload audio file
            await storageRef.put(audioBlob);
            const audioUrl = await storageRef.getDownloadURL();
            
            // Update question with audio URL
            await db.collection('questions').doc(questionId).update({
                audioAnswerUrl: audioUrl
            });
            
            showSuccess('Audio answer saved successfully.');
        } catch (error) {
            showError('Failed to save audio answer. Please try again.');
            console.error('Audio upload error:', error);
        }
    }

    // Initialize WebSocket connection for real-time feedback
    function initializeWebSocket() {
        // Simulated WebSocket connection (would be replaced with actual WebSocket implementation)
        console.log('Initializing WebSocket connection for real-time feedback...');
        // In a real implementation, this would connect to your WebSocket server
        // and handle incoming feedback messages
    }

    // Set up network monitoring
    function setupNetworkMonitor() {
        networkStatusCheckInterval = setInterval(() => {
            const wasConnected = isNetworkConnected;
            isNetworkConnected = navigator.onLine;
            
            if (!isNetworkConnected && wasConnected) {
                // Network went offline
                networkStatus.style.display = 'block';
                networkIcon.style.backgroundColor = '#f44336';
                networkMessage.textContent = 'Network connection lost';
                showError('Network connection lost. Some features may not work until connection is restored.');
            } else if (isNetworkConnected && !wasConnected) {
                // Network came back online
                networkStatus.style.display = 'block';
                networkIcon.style.backgroundColor = '#4CAF50';
                networkMessage.textContent = 'Network connection restored';
                showSuccess('Network connection restored.');
                setTimeout(() => {
                    networkStatus.style.display = 'none';
                }, 3000);
            }
        }, 5000);
    }

    // Handle window resize for responsive design
    function handleResize() {
        // Adjust layout for mobile devices
        if (window.innerWidth < 768) {
            interviewPage.style.padding = '10px';
        } else {
            interviewPage.style.padding = '20px';
        }
    }

    // Show success message
    function showSuccess(message) {
        const notification = document.createElement('div');
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.left = '50%';
        notification.style.transform = 'translateX(-50%)';
        notification.style.backgroundColor = '#4CAF50';
        notification.style.color = 'white';
        notification.style.padding = '10px 20px';
        notification.style.borderRadius = '4px';
        notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        notification.style.zIndex = '1000';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.transition = 'opacity 0.5s';
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 500);
        }, 3000);
    }

    // Show error message
    function showError(message) {
        const notification = document.createElement('div');
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.left = '50%';
        notification.style.transform = 'translateX(-50%)';
        notification.style.backgroundColor = '#f44336';
        notification.style.color = 'white';
        notification.style.padding = '10px 20px';
        notification.style.borderRadius = '4px';
        notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        notification.style.zIndex = '1000';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.transition = 'opacity 0.5s';
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 500);
        }, 3000);
    }

    // Redirect to login page
    function redirectToLogin() {
        window.location.href = 'login.html';
    }

    // Initialize on load
    handleResize();
</script>
</body>
</html>